on:
  pull_request:
    branches:
      - 'main'

jobs:
  track_pr:
    runs-on: ubuntu-latest
    steps:
      - run: |
          numOpenIssues="$(gh api graphql -F owner=$OWNER -F name=$REPO -f query='
            query($name: String!, $owner: String!) {
              repository(owner: $owner, name: $name) {
                issues(states:OPEN){
                  totalCount
                }
              }
            }
          ' --jq '.data.repository.issues.totalCount')"

          echo 'NUM_OPEN_ISSUES='$numOpenIssues >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
      - run: |
          gh issue create --title "Issue report" --body "$NUM_OPEN_ISSUES issues remaining" --repo $GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  watch_k8s_releases:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout
      uses: actions/checkout@ec3a7ce113134d7a93b817d10a8272cb61118579 # v2.4.0

    - name: Set up Go 
      uses: actions/setup-go@424fc82d43fa5a37540bae62709ddcc23d9520d4 # v2.1.5
      with:
        go-version: 1.17

    - name: GitHub Action
      run: |
        cd ci/ami
        go run github-action/main.go
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CAPA_ACTION_BASE_BRANCH: "main"
          CAPA_ACTION_HEAD_BRANCH: "ami-build-action"
          AMI_BUILD_CONFIG_FILENAME: "AMIBuildConfig.json"
          CAPA_ACTION_PR_REVIEWERS: "zeborg"
          CAPA_ACTION_PR_ASSIGNEES: "zeborg"
          CAPA_ACTION_DEFAULTS: "Defaults.json"
